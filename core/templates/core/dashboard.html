
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Sim√ºlat√∂r</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a',
                        sidebar: '#1e293b',
                        card: '#334155',
                        accent: '#3b82f6',
                        success: '#10b981',
                        error: '#ef4444',
                        text: '#e2e8f0'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .code-block { font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 11px; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="h-16 border-b border-gray-700 bg-sidebar flex items-center justify-between px-6 shrink-0 z-20 shadow-md">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center font-bold text-white shadow-lg">EP</div>
            <h1 class="font-bold text-lg tracking-wide"> <span class="text-gray-400 font-normal">Entegrasyon Sim√ºlat√∂r√º</span></h1>
        </div>
        
        <!-- Global Settings -->
        <div class="flex items-center gap-4">
            <div class="relative group">
                <label class="absolute -top-2.5 left-2 bg-sidebar px-1 text-[10px] text-gray-400">Hedef API (Base URL)</label>
                <!-- Default URL updated to http by default for local mock, user can change to https://eastpay.site -->
                <input type="text" id="baseUrl" class="bg-dark border border-gray-600 rounded px-3 py-1.5 text-xs w-64 text-gray-300 focus:outline-none focus:border-accent transition-colors" value="http://127.0.0.1:8000/api">
            </div>
            <div class="relative group">
                <label class="absolute -top-2.5 left-2 bg-sidebar px-1 text-[10px] text-gray-400">API Anahtarƒ±</label>
                <input type="password" id="apiKey" class="bg-dark border border-gray-600 rounded px-3 py-1.5 text-xs w-48 text-gray-300 focus:outline-none focus:border-accent transition-colors" placeholder="API Key">
            </div>
            <button onclick="saveSettings()" class="text-xs text-blue-400 hover:text-blue-300 underline">Ayarlarƒ± Kaydet</button>
            <button onclick="openWebhookModal()" class="ml-4 flex items-center gap-1.5 px-3 py-1.5 bg-pink-600 hover:bg-pink-500 text-white text-xs rounded transition-all shadow-lg hover:shadow-pink-500/20">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                Webhook Inbox
            </button>
            <a href="{% url 'logout' %}" class="ml-4 text-xs text-red-400 hover:text-red-300">√áƒ±kƒ±≈ü</a>
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- LEFT PANEL: Forms -->
        <div class="w-5/12 bg-sidebar flex flex-col border-r border-gray-700 shadow-xl z-10 relative">
            <div class="p-6 flex-1 overflow-y-auto">
                
                <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">ƒ∞≈ülem Se√ßimi</h2>
                
                <!-- Scenario Selector -->
                <div class="mb-6">
                    <select id="scenarioSelector" onchange="loadScenario()" class="w-full bg-dark border border-gray-600 rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-accent shadow-sm">
                        <option value="test_connection">üîç Baƒülantƒ± Testi</option>
                        <option value="get_account">1. Yatƒ±rƒ±m - Hesap ƒ∞ste (Token Al)</option>
                        <option value="create_transaction">2. Yatƒ±rƒ±m - Token ile Onay</option>
                        <option value="create_transaction_direct">2.5 Yatƒ±rƒ±m - Direkt (Token'sƒ±z)</option>
                        <option value="scenario_blocked_user">‚ö†Ô∏è Test: Yasaklƒ± Kullanƒ±cƒ± (403)</option>
                        <option value="scenario_invalid_amount">‚ö†Ô∏è Test: Hatalƒ± Tutar (Negatif)</option>
                        <option value="scenario_maintenance">‚ö†Ô∏è Test: Sunucu Bakƒ±m Modu (503)</option>
                        <option value="withdraw_request">3. √áekim Olu≈ütur (withdraw-request)</option>
                    </select>
                </div>

                <!-- Info Box (Token) -->
                <div id="tokenBox" class="hidden mb-6 bg-indigo-900/30 border border-indigo-500/30 rounded-lg p-3">
                    <div class="text-[10px] text-indigo-300 uppercase font-bold mb-1">Mevcut Process Token</div>
                    <div class="flex gap-2">
                        <input type="text" id="cachedToken" readonly class="flex-1 bg-transparent text-xs font-mono text-white outline-none" value="-">
                        <button onclick="copyToken()" class="text-xs text-indigo-400 hover:text-white">Kopyala</button>
                    </div>
                </div>

                <!-- Dynamic Form Container -->
                <div id="formContainer" class="space-y-4 animate-fadeIn">
                    <!-- Forms injected by JS -->
                </div>

            </div>

            <!-- Action Bar -->
            <div class="p-6 border-t border-gray-700 bg-sidebar/50 backdrop-blur-sm">
                <button onclick="executeScenario()" id="executeBtn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold py-4 px-6 rounded-lg shadow-lg transform transition-all hover:scale-[1.02] flex items-center justify-center gap-2">
                    <span>ƒ∞steƒüi G√∂nder</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </button>
            </div>
        </div>

        <!-- RIGHT PANEL: Terminal / Results -->
        <div class="w-7/12 bg-dark flex flex-col relative">
            
            <!-- Tabs -->
            <div class="h-12 border-b border-gray-700 flex text-sm justify-between bg-[#131b2e]">
                <div class="flex">
                    <button onclick="switchTab('response')" id="tab-response" class="px-6 border-b-2 border-green-500 text-green-400 font-medium bg-gray-800/30 transition-colors py-3">Gelen Cevap</button>
                    <button onclick="switchTab('request')" id="tab-request" class="px-6 border-b-2 border-transparent text-gray-500 hover:text-gray-300 font-medium transition-colors py-3">G√∂nderilen JSON</button>
                </div>
                
                <!-- HTML Toggles (Initially Hidden) -->
                <div id="htmlToggles" class="hidden flex items-center mr-4 gap-2">
                    <button onclick="toggleHtmlView('preview')" id="btn-preview" class="px-3 py-1.5 text-[10px] font-bold uppercase rounded bg-indigo-600 text-white shadow-md hover:bg-indigo-500 transition-colors flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        √ñnizleme
                    </button>
                    <button onclick="toggleHtmlView('source')" id="btn-source" class="px-3 py-1.5 text-[10px] font-bold uppercase rounded bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                        Kaynak Kodu
                    </button>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-gray-600 mt-12 bg-dark z-0">
                <svg class="w-16 h-16 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                <p class="text-sm">ƒ∞≈ülem se√ßip teste ba≈ülayƒ±n.</p>
            </div>

            <!-- Content Area -->
            <div id="resultContent" class="flex-1 overflow-hidden hidden flex flex-col z-10 bg-dark">
                
                <!-- Status Bar -->
                <div class="p-4 flex items-center justify-between border-b border-gray-800 bg-[#0b1121]">
                    <div id="statusBadge" class="px-3 py-1 rounded text-[10px] font-bold bg-gray-700 text-gray-300 flex items-center gap-2 uppercase tracking-wide shadow-sm">
                        <span class="w-1.5 h-1.5 rounded-full bg-gray-400"></span>
                        BEKLƒ∞YOR
                    </div>
                    <div class="text-[10px] text-gray-500 font-mono flex gap-4 items-center">
                        <span id="contentTypeBadge" class="hidden px-2 py-0.5 rounded bg-blue-900/30 text-blue-400 border border-blue-800/50">JSON</span>
                        <span id="metaTime">0 ms</span>
                        <span id="metaSize">0 KB</span>
                    </div>
                </div>

                <!-- Text Views (Code & Request) -->
                <div class="flex-1 overflow-auto bg-[#0b1121] relative group">
                    <button id="copyBtn" onclick="copyContent()" class="hidden absolute top-4 right-4 text-[10px] bg-gray-700 text-gray-300 px-3 py-1.5 rounded opacity-0 group-hover:opacity-100 hover:bg-gray-600 transition-all shadow-lg border border-gray-600 z-50">Kopyala</button>
                    
                    <!-- Code View (JSON or HTML Source) -->
                    <pre id="view-response" class="code-block text-gray-300 p-6 min-h-full whitespace-pre-wrap break-all"></pre>
                    
                    <!-- Request View -->
                    <pre id="view-request" class="code-block text-indigo-300 hidden p-6 min-h-full whitespace-pre-wrap break-all"></pre>
                    
                    <!-- HTML Preview Iframe (Fullscreen overlay) -->
                    <div id="preview-container" class="hidden absolute inset-0 bg-white">
                        <div class="absolute top-2 right-2 bg-yellow-100 text-yellow-800 px-2 py-1 text-[10px] rounded border border-yellow-300 opacity-75 hover:opacity-100 pointer-events-none z-50">Sim√ºle Edilmi≈ü Tarayƒ±cƒ± G√∂r√ºn√ºm√º</div>
                        <iframe id="view-preview" class="w-full h-full border-none"></iframe>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Webhook Modal -->
    <div id="webhookModal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-12 backdrop-blur-sm">
        <div class="bg-gray-900 w-full h-full max-w-6xl rounded-xl shadow-2xl border border-gray-700 flex flex-col overflow-hidden">
            
            <!-- Modal Header -->
            <div class="h-14 border-b border-gray-700 flex items-center justify-between px-6 bg-gray-800">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded bg-pink-600 flex items-center justify-center text-white">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </div>
                    <h2 class="font-bold text-white">Webhook Inbox <span class="text-xs font-normal text-gray-400 ml-2">(Canlƒ± Akƒ±≈ü)</span></h2>
                </div>
                <button onclick="closeWebhookModal()" class="text-gray-400 hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 flex overflow-hidden">
                <!-- Sidebar List -->
                <div id="webhookList" class="w-1/3 border-r border-gray-700 overflow-y-auto bg-gray-900/50">
                    <!-- Dynamic List Items -->
                    <div class="p-4 text-center text-gray-500 text-xs">Y√ºkleniyor...</div>
                </div>

                <!-- Detail View -->
                <div id="webhookDetail" class="w-2/3 bg-black/20 p-6 overflow-auto">
                    <div id="webhookDetailPlaceholder" class="flex flex-col items-center justify-center h-full text-gray-600">
                        <svg class="w-12 h-12 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                        <p class="text-xs">Detay g√∂rmek i√ßin soldan bir webhook se√ßin.</p>
                    </div>
                    <div id="webhookDetailView" class="hidden h-full flex flex-col">
                         <div class="flex justify-between items-center mb-4">
                             <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Payload ƒ∞√ßeriƒüi</span>
                             <button class="text-xs text-indigo-400 hover:text-indigo-300">JSON Kopyala</button>
                         </div>
                         <pre id="webhookDetailContent" class="code-block text-green-300 text-xs flex-1 overflow-auto whitespace-pre-wrap outline-none"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Logic -->
    <script>
        // --- State ---
        const CSRF_TOKEN = getCookie('csrftoken');
        let currentProcessToken = localStorage.getItem('nx_process_token') || '';
        let lastResponseData = null; // Store for toggling views

        // --- Config ---
        const SCENARIOS = {
            'test_connection': {
                path: '/test-connection/',
                method: 'GET',
                fields: []
            },
            'get_account': {
                path: '/get-eligible-account/', // Added trailing slash to match typical django/rest patterns, update if strictly no-slash
                method: 'POST',
                fields: [
                    { id: 'amount', label: 'Tutar (Miktar)', type: 'text', value: '15000', placeholder: '15000' }
                ]
            },
            'create_transaction': {
                path: '/create-transaction/',
                method: 'POST',
                fields: [
                    { id: 'process_token', label: 'Process Token (Otomatik)', type: 'text', value: '', placeholder: 'get-account ile alƒ±nƒ±r' },
                    { id: 'user_id', label: 'User ID', type: 'text', value: 'Testuser123', placeholder: 'Kullanƒ±cƒ± ID' },
                    { id: 'full_name', label: 'Ad Soyad', type: 'text', value: 'Test Kullanƒ±cƒ±sƒ±', placeholder: 'Ad Soyad' },
                    { id: 'external_id', label: 'External ID (Order ID)', type: 'text', value: 'order_' + Math.floor(Math.random()*10000), placeholder: 'Sipari≈ü No' },
                    { id: 'callback_url', label: 'Callback URL', type: 'text', value: 'https://webhook.site/test', placeholder: 'Webhook' }
                ]
            },
            'create_transaction_direct': {
                path: '/create-transaction/',
                method: 'POST',
                fields: [
                    { id: 'amount', label: 'Tutar (Miktar)', type: 'text', value: '5000', placeholder: '5000' },
                    { id: 'user_id', label: 'User ID', type: 'text', value: 'USER_123451', placeholder: 'Kullanƒ±cƒ± ID' },
                    { id: 'full_name', label: 'Ad Soyad', type: 'text', value: 'Veysel ≈ûahin', placeholder: 'Ad Soyad' },
                    { id: 'external_id', label: 'External ID', type: 'text', value: 'order_' + Math.floor(Math.random()*10000), placeholder: 'Sipari≈ü No' },
                    { id: 'callback_url', label: 'Callback URL', type: 'text', value: 'https://webhook.site/test', placeholder: 'Webhook' }
                ]
            },
            'scenario_blocked_user': {
                path: '/create-transaction/',
                method: 'POST',
                fields: [
                    { id: 'amount', label: 'Tutar', type: 'text', value: '1000', placeholder: '1000' },
                    { id: 'user_id', label: 'User ID', type: 'text', value: 'BLOCKED_USER', placeholder: 'Kullanƒ±cƒ± ID' },
                    { id: 'full_name', label: 'Ad Soyad', type: 'text', value: 'Yasaklƒ± Kullanƒ±cƒ±', placeholder: 'Ad Soyad' }
                ]
            },
            'scenario_invalid_amount': {
                path: '/create-transaction/',
                method: 'POST',
                fields: [
                    { id: 'amount', label: 'Tutar (Negatif Test)', type: 'text', value: '-500', placeholder: '-500' },
                    { id: 'user_id', label: 'User ID', type: 'text', value: 'TEST_USER', placeholder: 'Kullanƒ±cƒ± ID' }
                ]
            },
            'scenario_maintenance': {
                path: '/create-transaction/',
                method: 'POST',
                fields: [
                    { id: 'amount', label: 'Tutar (503 trigger)', type: 'text', value: '503', placeholder: '503' },
                     { id: 'user_id', label: 'User ID', type: 'text', value: 'TEST_USER', placeholder: 'Kullanƒ±cƒ± ID' }
                ]
            },
            'withdraw_request': {
                path: '/public/withdraw-request/',
                method: 'POST',
                fields: [
                    { id: 'customer_name', label: 'Alƒ±cƒ± Adƒ± Soyadƒ±', type: 'text', value: 'AHMET OOOOOO', placeholder: 'Kime' },
                    { id: 'customer_iban', label: 'IBAN', type: 'text', value: 'TR18231289327218937913', placeholder: 'TR...' },
                    { id: 'amount', label: '√áekim Tutarƒ±', type: 'number', value: 15000.00, placeholder: '15000.00' },
                    { id: 'external_id', label: 'External ID', type: 'text', value: 'withdraw_' + Math.floor(Math.random()*10000), placeholder: 'ƒ∞≈ülem No' }
                ]
            }
        };

        // --- Init ---
        window.onload = () => {
            const savedUrl = localStorage.getItem('nx_base_url');
            if (savedUrl) document.getElementById('baseUrl').value = savedUrl;
            
            const savedKey = localStorage.getItem('nx_api_key');
            if (savedKey) document.getElementById('apiKey').value = savedKey;

            if (currentProcessToken) {
                document.getElementById('cachedToken').value = currentProcessToken;
                document.getElementById('tokenBox').classList.remove('hidden');
            }

            loadScenario();
        };

        // --- Actions ---
        function loadScenario() {
            const key = document.getElementById('scenarioSelector').value;
            const config = SCENARIOS[key];
            const container = document.getElementById('formContainer');
            
            container.innerHTML = ''; 

            config.fields.forEach(f => {
                // Auto-fill process token if available
                let val = f.value;
                if (f.id === 'process_token' && currentProcessToken) val = currentProcessToken;
                if (f.id === 'external_id' && (key === 'create_transaction' || key === 'withdraw_request')) val = key.substring(0,4) + '_' + Math.floor(Math.random()*100000);

                container.innerHTML += `
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">${f.label}</label>
                        <input type="${f.type}" id="field_${f.id}" value="${val}" placeholder="${f.placeholder}" 
                            class="w-full bg-card border border-gray-600 rounded p-2.5 text-xs text-white focus:border-accent outline-none font-mono">
                    </div>
                `;
            });
        }

        async function executeScenario() {
            const btn = document.getElementById('executeBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="animate-pulse">ƒ∞≈üleniyor...</span>';
            
            try {
                // Prep
                const key = document.getElementById('scenarioSelector').value;
                const config = SCENARIOS[key];
                const baseUrl = document.getElementById('baseUrl').value.replace(/\/$/, '');
                const targetUrl = baseUrl + config.path;
                const apiKey = document.getElementById('apiKey').value;

                // Payload
                let payload = {};
                config.fields.forEach(f => {
                    const el = document.getElementById('field_' + f.id);
                    // Special logic for amount string/number
                    if (f.id === 'amount' && key === 'get_account') {
                        payload[f.id] = String(el.value); // Ensure string for get-account
                    } else if (f.type === 'number') {
                         payload[f.id] = parseFloat(el.value);
                    } else {
                        payload[f.id] = el.value;
                    }
                });

                // Headers
                let headers = { 'Content-Type': 'application/json' };
                if (apiKey) {
                    headers['X-API-KEY'] = apiKey; 
                }

                // UI Updates
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('resultContent').classList.remove('hidden');
                document.getElementById('view-request').innerText = JSON.stringify(payload, null, 4);

                // Call Backend Proxy
                const startTime = performance.now();
                const res = await fetch('/api/run-diagnostic/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
                    body: JSON.stringify({
                        test_type: 'custom',
                        target_url: targetUrl,
                        http_method: config.method,
                        payload: payload,
                        custom_headers: headers
                    })
                });
                
                const data = await res.json();
                const duration = Math.round(performance.now() - startTime);

                // Analyze & Render
                lastResponseData = data; // Store globally
                renderResult(data, duration);

                // Logic: Capture Process Token
                if (key === 'get_account' && data.json && data.json.process_token) {
                    currentProcessToken = data.json.process_token;
                    localStorage.setItem('nx_process_token', currentProcessToken);
                    document.getElementById('cachedToken').value = currentProcessToken;
                    document.getElementById('tokenBox').classList.remove('hidden');
                }

            } catch (err) {
                document.getElementById('view-response').innerText = err.message;
            } finally {
                btn.innerHTML = originalText;
                // Auto switch to response, but keep view mode logic
                 switchTab('response');
            }
        }

        function renderResult(data, ms) {
             const statusBadge = document.getElementById('statusBadge');
             const view = document.getElementById('view-response');
             const toggles = document.getElementById('htmlToggles');
             const typeBadge = document.getElementById('contentTypeBadge');
             const copyBtn = document.getElementById('copyBtn');
             
             let code = data.status_code || 0;
             let color = code >= 200 && code < 300 ? 'bg-green-600' : 'bg-red-600';
             let text = code >= 200 && code < 300 ? 'BA≈ûARILI' : 'HATA';
             
             // Update Status Bar
             statusBadge.className = `px-3 py-1 rounded text-[10px] font-bold text-white flex items-center gap-2 uppercase tracking-wide ${color}`;
             statusBadge.innerHTML = `<span class="opacity-75">${code}</span> ${text}`;
             
             document.getElementById('metaTime').innerText = ms + ' ms';
             
             // Determine Content Type
             let isHtml = false;
             let rawContent = "";

             if (typeof data.json === 'string') {
                 rawContent = data.json;
                 // Primitive HTML detection
                 if (rawContent.trim().startsWith('<') || rawContent.includes('<!DOCTYPE') || rawContent.includes('<html')) {
                     isHtml = true;
                 }
             } else {
                 rawContent = JSON.stringify(data.json || data, null, 4);
             }

             // Handle UI based on Type
             document.getElementById('metaSize').innerText = (rawContent.length / 1024).toFixed(2) + ' KB';
             
             typeBadge.innerText = isHtml ? 'HTML' : 'JSON';
             typeBadge.classList.remove('hidden');
             copyBtn.classList.remove('hidden');

             if (isHtml) {
                 // HTML Mode
                 toggles.classList.remove('hidden');
                 view.innerText = rawContent; // Source View
                 // Fill Iframe
                 const iframeDoc = document.getElementById('view-preview').contentWindow.document;
                 iframeDoc.open();
                 iframeDoc.write(rawContent);
                 iframeDoc.close();
                 
                 // Auto-show preview for HTML errors
                 toggleHtmlView('preview');
             } else {
                 // JSON Mode
                 toggles.classList.add('hidden');
                 document.getElementById('preview-container').classList.add('hidden');
                 document.getElementById('view-response').classList.remove('hidden');
                 view.innerHTML = syntaxHighlight(rawContent);
             }
        }

        function toggleHtmlView(mode) {
            const previewContainer = document.getElementById('preview-container');
            const sourceView = document.getElementById('view-response');
            const btnPreview = document.getElementById('btn-preview');
            const btnSource = document.getElementById('btn-source');

            // Reset Styles
            btnPreview.className = "px-3 py-1.5 text-[10px] font-bold uppercase rounded transition-colors flex items-center gap-1 bg-gray-700 text-gray-300 hover:bg-gray-600";
            btnSource.className = "px-3 py-1.5 text-[10px] font-bold uppercase rounded transition-colors flex items-center gap-1 bg-gray-700 text-gray-300 hover:bg-gray-600";

            if (mode === 'preview') {
                previewContainer.classList.remove('hidden');
                sourceView.classList.add('hidden');
                btnPreview.className = "px-3 py-1.5 text-[10px] font-bold uppercase rounded bg-indigo-600 text-white shadow-md hover:bg-indigo-500 transition-colors flex items-center gap-1";
            } else {
                previewContainer.classList.add('hidden');
                sourceView.classList.remove('hidden');
                btnSource.className = "px-3 py-1.5 text-[10px] font-bold uppercase rounded bg-indigo-600 text-white shadow-md hover:bg-indigo-500 transition-colors flex items-center gap-1";
            }
        }
        
        // --- Webhook System ---
        let webhookInterval = null;

        function openWebhookModal() {
            document.getElementById('webhookModal').classList.remove('hidden');
            fetchWebhooks();
            webhookInterval = setInterval(fetchWebhooks, 3000); // Poll every 3s
        }

        function closeWebhookModal() {
            document.getElementById('webhookModal').classList.add('hidden');
            if (webhookInterval) clearInterval(webhookInterval);
        }

        async function fetchWebhooks() {
            try {
                const res = await fetch('/api/get-webhook-logs/', { headers: { 'X-CSRFToken': CSRF_TOKEN } });
                const data = await res.json();
                renderWebhooks(data.logs);
            } catch (err) {
                console.error("Webhook Fetch Error:", err);
            }
        }

        function renderWebhooks(logs) {
            const list = document.getElementById('webhookList');
            const detail = document.getElementById('webhookDetail');
            
            // Keep selected item visible if any
            // For now, just rebuild list
            list.innerHTML = logs.map(log => `
                <div onclick="showWebhookDetail('${log.id}')" class="p-3 border-b border-gray-700 hover:bg-gray-700 cursor-pointer transition-colors group">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-bold text-accent">${log.method}</span>
                        <span class="text-[10px] text-gray-500">${log.timestamp}</span>
                    </div>
                    <div class="text-[10px] text-gray-400 truncate font-mono">${JSON.stringify(log.body).substring(0,40)}...</div>
                    <textarea id="data-${log.id}" class="hidden">${JSON.stringify(log, null, 4)}</textarea>
                </div>
            `).join('');
        }

        function showWebhookDetail(id) {
            const data = document.getElementById('data-' + id).value;
            const detailView = document.getElementById('webhookDetailContent');
            detailView.innerHTML = syntaxHighlight(data);
            document.getElementById('webhookDetailPlaceholder').classList.add('hidden');
            document.getElementById('webhookDetailView').classList.remove('hidden');
        }

        // --- Utils ---
        function saveSettings() {
            localStorage.setItem('nx_base_url', document.getElementById('baseUrl').value);
            localStorage.setItem('nx_api_key', document.getElementById('apiKey').value);
            alert('Ayarlar Kaydedildi');
        }
        
        function switchTab(t) {
            // If explicitly clicking tabs, hide preview overlay unless we are in response mode + html?
            // Actually, tabs separate Request vs Response. Inside Response we have Preview vs Source.
            
            // Hide everything first
            document.getElementById('view-response').classList.add('hidden');
            document.getElementById('view-request').classList.add('hidden');
            document.getElementById('preview-container').classList.add('hidden'); // Also hide separate preview layer
            
            document.getElementById('tab-response').className = "px-6 border-b-2 border-transparent text-gray-500 hover:text-gray-300 font-medium transition-colors py-3";
            document.getElementById('tab-request').className = "px-6 border-b-2 border-transparent text-gray-500 hover:text-gray-300 font-medium transition-colors py-3";
            
            if(t==='response') {
                document.getElementById('tab-response').className = "px-6 border-b-2 border-green-500 text-green-400 font-medium bg-gray-800/30 transition-colors py-3";
                
                // If last response was HTML, we might want to restore HTML view state?
                // For simplicity, just show the last active view or default.
                // Let's check if the html toggles are visible (meaning we have HTML content)
                const isHtmlMode = !document.getElementById('htmlToggles').classList.contains('hidden');
                if (isHtmlMode) {
                   // Check which button is active
                   const isPreviewActive = document.getElementById('btn-preview').classList.contains('bg-indigo-600');
                   if (isPreviewActive) toggleHtmlView('preview');
                   else toggleHtmlView('source');
                } else {
                    document.getElementById('view-response').classList.remove('hidden');
                }

            } else {
                 document.getElementById('tab-request').className = "px-6 border-b-2 border-indigo-500 text-indigo-400 font-medium bg-gray-800/30 transition-colors py-3";
                 document.getElementById('view-request').classList.remove('hidden');
                 // Ensure preview is hidden
                 document.getElementById('preview-container').classList.add('hidden');
            }
        }

        function getCookie(name) {
            if (!document.cookie) return null;
            const cookies = document.cookie.split(';');
            for (let c of cookies) {
                if (c.trim().startsWith(name + '=')) return decodeURIComponent(c.trim().substring(name.length + 1));
            }
            return null;
        }
        
        function copyContent() {
            // Copy whatever is visible
            let text = "";
            if (!document.getElementById('view-request').classList.contains('hidden')) {
                text = document.getElementById('view-request').innerText;
            } else if (!document.getElementById('view-response').classList.contains('hidden')) {
                 text = document.getElementById('view-response').innerText;
            }
            if(text) {
                navigator.clipboard.writeText(text);
                const btn = document.getElementById('copyBtn');
                const orig = btn.innerText;
                btn.innerText = "Kopyalandƒ±!";
                setTimeout(() => btn.innerText = orig, 1000);
            }
        }

        function syntaxHighlight(json) {
            if (typeof json !== 'string') return json; // Safety
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                var cls = 'text-green-300';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) cls = 'text-indigo-300 font-bold';
                    else cls = 'text-green-300';
                } else if (/true|false/.test(match)) cls = 'text-purple-300';
                else if (/null/.test(match)) cls = 'text-gray-500';
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }
    </script>
</body>
</html>
