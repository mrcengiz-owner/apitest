<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexKasa API Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a',
                        card: '#1e293b',
                        accent: '#3b82f6',
                        success: '#10b981',
                        error: '#ef4444',
                        warning: '#f59e0b',
                        border: '#334155'
                    },
                    fontFamily: {
                        mono: ['SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', '"Liberation Mono"', '"Courier New"', 'monospace']
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; overflow: hidden; }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #94a3b8; }
        .method-GET { color: #3b82f6; }
        .method-POST { color: #10b981; }
        .method-PUT { color: #f59e0b; }
        .method-DELETE { color: #ef4444; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Header -->
    <header class="h-14 border-b border-gray-700 bg-card flex items-center justify-between px-6 shrink-0">
        <div class="flex items-center space-x-3">
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 w-8 h-8 rounded-lg flex items-center justify-center font-bold text-white shadow-lg shadow-blue-500/20">Nx</div>
            <h1 class="font-bold text-lg tracking-tight">NexKasa <span class="text-gray-400 font-normal">API Lab</span></h1>
        </div>
        <div class="flex items-center space-x-4 text-xs">
             <div class="flex items-center space-x-1.5 bg-dark/50 px-3 py-1.5 rounded-full border border-gray-700/50">
                <span class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></span>
                <span class="text-gray-300">System Ready</span>
            </div>
        </div>
    </header>

    <!-- Main Workspace -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- Left Pane: Request Builder -->
        <div class="w-1/2 flex flex-col border-r border-gray-700 bg-[#131c31]">
            
            <!-- Address Bar -->
            <div class="p-4 border-b border-gray-700 flex gap-2">
                <select id="httpMethod" class="bg-card border border-gray-600 rounded-lg px-3 py-2 text-sm font-bold focus:outline-none focus:border-accent w-28 method-GET" onchange="updateMethodColor(this)">
                    <option value="GET" class="text-blue-500">GET</option>
                    <option value="POST" class="text-green-500">POST</option>
                    <option value="PUT" class="text-yellow-500">PUT</option>
                    <option value="DELETE" class="text-red-500">DELETE</option>
                </select>
                <input type="text" id="targetUrl" value="http://127.0.0.1:8000/api/test-connection/" 
                    class="flex-1 bg-dark border border-gray-600 rounded-lg px-4 py-2 text-sm text-gray-200 focus:outline-none focus:border-accent font-mono"
                    placeholder="Enter URL">
                <button onclick="sendRequest()" class="bg-blue-600 hover:bg-blue-500 text-white font-semibold px-6 py-2 rounded-lg text-sm shadow-lg shadow-blue-600/20 transition-all flex items-center">
                    <span id="btnText">Send</span>
                    <svg id="btnLoader" class="hidden animate-spin ml-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-gray-700 px-4 space-x-6 text-sm">
                <button onclick="switchTab('headers')" id="tab-btn-headers" class="py-3 font-medium tab-active transition-colors">Headers</button>
                <button onclick="switchTab('body')" id="tab-btn-body" class="py-3 font-medium tab-inactive transition-colors hover:text-gray-300">Body</button>
                <button onclick="switchTab('auth')" id="tab-btn-auth" class="py-3 font-medium tab-inactive transition-colors hover:text-gray-300">Auth</button>
            </div>

            <!-- Tab Content -->
            <div class="flex-1 overflow-y-auto p-4">
                
                <!-- Headers Tab -->
                <div id="tab-headers" class="space-y-3">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Request Headers</h3>
                        <button onclick="addHeaderRow()" class="text-xs text-blue-400 hover:text-blue-300">+ Add New</button>
                    </div>
                    <div id="headers-container" class="space-y-2">
                        <!-- Default Header -->
                        <div class="flex gap-2 group header-row">
                            <input type="text" placeholder="Key" value="Content-Type" class="bg-transparent border border-gray-700 rounded px-3 py-1.5 text-xs text-gray-300 w-1/3 focus:border-gray-500 focus:outline-none">
                            <input type="text" placeholder="Value" value="application/json" class="bg-transparent border border-gray-700 rounded px-3 py-1.5 text-xs text-gray-300 flex-1 focus:border-gray-500 focus:outline-none">
                             <button onclick="removeRow(this)" class="text-gray-600 hover:text-red-400 opacity-0 group-hover:opacity-100 px-2 transition-opacity">×</button>
                        </div>
                    </div>
                </div>

                <!-- Body Tab -->
                <div id="tab-body" class="hidden h-full flex flex-col">
                    <div class="text-xs text-gray-500 mb-2 flex justify-between">
                        <span>raw (JSON)</span>
                        <button onclick="formatJson()" class="text-blue-400 hover:text-blue-300">Beautify</button>
                    </div>
                    <textarea id="requestBody" class="flex-1 bg-[#0b1121] border border-gray-700 rounded-lg p-4 font-mono text-xs text-green-400 focus:outline-none focus:border-gray-600 resize-none leading-relaxed" spellcheck="false" placeholder='{ "key": "value" }'></textarea>
                </div>
                
                <!-- Auth Tab -->
                <div id="tab-auth" class="hidden">
                     <div class="bg-card/50 rounded-lg p-4 border border-gray-700/50">
                        <label class="block text-xs font-semibold text-gray-400 mb-2">API Key (X-API-KEY)</label>
                        <div class="flex gap-2">
                            <input type="password" id="apiKeyInput" class="flex-1 bg-dark border border-gray-600 rounded px-3 py-2 text-sm text-white focus:outline-none focus:border-accent" placeholder="Paste your API Key here">
                            <button onclick="applyApiKey()" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded text-xs border border-gray-600">Add to Headers</button>
                        </div>
                        <p class="text-[10px] text-gray-500 mt-2">Clicking "Add" will automatically insert an `X-API-KEY` row into the Headers tab.</p>
                     </div>
                </div>

            </div>
        </div>

        <!-- Right Pane: Response -->
        <div class="w-1/2 flex flex-col bg-[#0b1121] relative">
            
            <!-- Empty State -->
            <div id="response-empty" class="absolute inset-0 flex flex-col items-center justify-center text-gray-600 z-0">
                <svg class="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                <p>Send a request to see the response</p>
            </div>

            <!-- Response Content (Initially Hidden) -->
            <div id="response-content" class="hidden flex flex-col h-full z-10 relative">
                
                <!-- Status Bar -->
                <div class="h-14 border-b border-gray-700/50 flex items-center justify-between px-6 bg-card/30">
                    <div class="flex items-center gap-4">
                        <div class="flex flex-col">
                            <span class="text-[10px] uppercase text-gray-500 font-bold">Status</span>
                            <span id="res-status" class="text-sm font-bold text-green-500">200 OK</span>
                        </div>
                        <div class="h-6 w-px bg-gray-700"></div>
                        <div class="flex flex-col">
                            <span class="text-[10px] uppercase text-gray-500 font-bold">Time</span>
                            <span id="res-time" class="text-sm font-mono text-gray-300">145ms</span>
                        </div>
                         <div class="h-6 w-px bg-gray-700"></div>
                        <div class="flex flex-col">
                            <span class="text-[10px] uppercase text-gray-500 font-bold">Size</span>
                            <span id="res-size" class="text-sm font-mono text-gray-300">1.2 KB</span>
                        </div>
                    </div>
                    <button onclick="copyResponse()" class="text-xs text-gray-400 hover:text-white flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        Copy
                    </button>
                </div>

                <!-- Response Body -->
                <div class="flex-1 overflow-auto p-4 bg-[#0b1121]">
                     <pre id="res-body" class="font-mono text-xs text-blue-300 whitespace-pre-wrap break-all"></pre>
                </div>
                
                <!-- Bottom: Response Headers View (Collapsible if needed, simpler to just show at bottom) -->
                <div class="border-t border-gray-800 p-4 bg-[#0f172a]">
                    <div class="text-[10px] text-gray-500 mb-2 uppercase tracking-wide">Headers Received</div>
                    <div id="res-headers" class="grid grid-cols-2 gap-x-4 gap-y-1 text-[11px] font-mono text-gray-400">
                        <!-- Headers injected here -->
                    </div>
                </div>

            </div>

        </div>
    </div>

    <script>
        // CSRF Token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                     if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // UI Logic
        function switchTab(tabName) {
            ['headers', 'body', 'auth'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden');
                document.getElementById(`tab-btn-${t}`).classList.remove('tab-active');
                document.getElementById(`tab-btn-${t}`).classList.add('tab-inactive');
            });
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-btn-${tabName}`).classList.add('tab-active');
            document.getElementById(`tab-btn-${tabName}`).classList.remove('tab-inactive');
        }

        function updateMethodColor(select) {
            const colors = {
                'GET': 'text-blue-500',
                'POST': 'text-green-500', 
                'PUT': 'text-yellow-500', 
                'DELETE': 'text-red-500'
            };
            select.className = select.className.replace(/text-\w+-500/g, '');
            select.classList.add(colors[select.value] || 'text-gray-500');
        }

        function addHeaderRow(key = '', value = '') {
            const container = document.getElementById('headers-container');
            const div = document.createElement('div');
            div.className = 'flex gap-2 group header-row animate-fadeIn';
            div.innerHTML = `
                <input type="text" placeholder="Key" value="${key}" class="bg-transparent border border-gray-700/50 rounded px-3 py-1.5 text-xs text-gray-300 w-1/3 focus:border-gray-500 focus:outline-none placeholder-gray-600">
                <input type="text" placeholder="Value" value="${value}" class="bg-transparent border border-gray-700/50 rounded px-3 py-1.5 text-xs text-gray-300 flex-1 focus:border-gray-500 focus:outline-none placeholder-gray-600">
                <button onclick="removeRow(this)" class="text-gray-600 hover:text-red-400 opacity-0 group-hover:opacity-100 px-2 transition-opacity">×</button>
            `;
            container.appendChild(div);
        }

        function removeRow(btn) {
            btn.parentElement.remove();
        }
        
        function applyApiKey() {
            const key = document.getElementById('apiKeyInput').value;
            if(key) {
                addHeaderRow('Authorization', `Bearer ${key}`); // Or X-API-KEY depending on standard
                // Also support custom key if user wants
                // addHeaderRow('X-API-KEY', key); 
                switchTab('headers');
            }
        }
        
        function formatJson() {
            const textarea = document.getElementById('requestBody');
            try {
                const val = JSON.parse(textarea.value);
                textarea.value = JSON.stringify(val, null, 4);
            } catch(e) { /* ignore */ }
        }

        // Request Logic
        async function sendRequest() {
            const method = document.getElementById('httpMethod').value;
            const url = document.getElementById('targetUrl').value;
            const btnText = document.getElementById('btnText');
            const btnLoader = document.getElementById('btnLoader');
            
            // Collect Body
            let bodyPayload = {};
            const bodyStr = document.getElementById('requestBody').value;
            if(bodyStr && method !== 'GET') {
                try {
                    bodyPayload = JSON.parse(bodyStr);
                } catch(e) {
                    alert('Invalid JSON in Body');
                    return;
                }
            }

            // Collect Headers
            let headers = {};
            document.querySelectorAll('.header-row').forEach(row => {
                const inputs = row.querySelectorAll('input');
                const key = inputs[0].value.trim();
                const val = inputs[1].value.trim();
                if(key) headers[key] = val;
            });

            // UI Loading
            btnText.innerText = 'Sending...';
            btnLoader.classList.remove('hidden');
            document.getElementById('response-empty').classList.add('hidden');
            document.getElementById('response-content').classList.remove('hidden');
            document.getElementById('res-body').innerHTML = '<span class="text-gray-500">Waiting for server...</span>';

            try {
                const startTime = performance.now();
                const res = await fetch('/api/run-diagnostic/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                    body: JSON.stringify({
                        test_type: 'custom',
                        target_url: url,
                        http_method: method,
                        payload: bodyPayload,
                        custom_headers: headers
                    })
                });
                
                const data = await res.json();
                const endTime = performance.now();
                
                // Update Response UI
                updateResponseUI(data, endTime - startTime);

            } catch(err) {
                 document.getElementById('res-status').innerText = 'ERROR';
                 document.getElementById('res-status').className = 'text-sm font-bold text-red-500';
                 document.getElementById('res-body').innerText = err.message;
            } finally {
                btnText.innerText = 'Send';
                btnLoader.classList.add('hidden');
            }
        }

        function updateResponseUI(data, timeTaken) {
            // Status Code
            const statusElem = document.getElementById('res-status');
            statusElem.innerText = `${data.status_code || 'Err'} ${getStatusText(data.status_code)}`;
            statusElem.className = `text-sm font-bold ${data.status_code >= 200 && data.status_code < 300 ? 'text-green-500' : 'text-red-500'}`;
            
            // Time
            document.getElementById('res-time').innerText = `${Math.round(timeTaken)}ms`;
            
            // Body
            const bodyText = typeof data.json === 'object' ? JSON.stringify(data.json, null, 2) : data.json;
            document.getElementById('res-body').innerHTML = syntaxHighlight(bodyText);
            document.getElementById('res-size').innerText = formatBytes(new Blob([bodyText]).size);

            // Headers
            const headersContainer = document.getElementById('res-headers');
            headersContainer.innerHTML = '';
            if(data.response_headers) {
                for (const [key, value] of Object.entries(data.response_headers)) {
                    headersContainer.innerHTML += `<div class="truncate"><span class="text-gray-500">${key}:</span> <span class="text-gray-300" title="${value}">${value}</span></div>`;
                }
            }
        }
        
        function getStatusText(code) {
             const statusTexts = { 200:'OK', 201:'Created', 400:'Bad Request', 401:'Unauthorized', 403:'Forbidden', 404:'Not Found', 500:'Server Error', 520:'Web Server Unknown' };
             return statusTexts[code] || '';
        }

        function formatBytes(bytes, decimals = 2) {
            if (!+bytes) return '0 B';
            const k = 1000; // using 1000 for network sizes usually
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }

        function syntaxHighlight(json) {
            if (typeof json != 'string') {
                 json = JSON.stringify(json, undefined, 2);
            }
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                var cls = 'text-green-300'; // string
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'text-blue-400 font-semibold'; // key
                    } else {
                        cls = 'text-green-300'; // string
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'text-yellow-400'; // boolean
                } else if (/null/.test(match)) {
                    cls = 'text-gray-500'; // null
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }
        
        function copyResponse() {
            const text = document.getElementById('res-body').innerText;
            navigator.clipboard.writeText(text);
        }

        // Init
        updateMethodColor(document.getElementById('httpMethod'));
    </script>
</body>
</html>
