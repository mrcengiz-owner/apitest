<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EastPay Sim√ºlat√∂r</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a',
                        sidebar: '#1e293b',
                        card: '#334155',
                        accent: '#3b82f6',
                        success: '#10b981',
                        error: '#ef4444',
                        text: '#e2e8f0'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .code-block { font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 11px; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="h-16 border-b border-gray-700 bg-sidebar flex items-center justify-between px-6 shrink-0 z-20 shadow-md">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center font-bold text-white shadow-lg">EP</div>
            <h1 class="font-bold text-lg tracking-wide">EastPay <span class="text-gray-400 font-normal">Entegrasyon Sim√ºlat√∂r√º</span></h1>
        </div>
        
        <!-- Global Settings -->
        <div class="flex items-center gap-4">
            <div class="relative group">
                <label class="absolute -top-2.5 left-2 bg-sidebar px-1 text-[10px] text-gray-400">Hedef API (Base URL)</label>
                <!-- Default URL updated to http by default for local mock, user can change to https://eastpay.site -->
                <input type="text" id="baseUrl" class="bg-dark border border-gray-600 rounded px-3 py-1.5 text-xs w-64 text-gray-300 focus:outline-none focus:border-accent transition-colors" value="http://127.0.0.1:8000/api">
            </div>
            <div class="relative group">
                <label class="absolute -top-2.5 left-2 bg-sidebar px-1 text-[10px] text-gray-400">API Anahtarƒ±</label>
                <input type="password" id="apiKey" class="bg-dark border border-gray-600 rounded px-3 py-1.5 text-xs w-48 text-gray-300 focus:outline-none focus:border-accent transition-colors" placeholder="API Key">
            </div>
            <button onclick="saveSettings()" class="text-xs text-blue-400 hover:text-blue-300 underline">Ayarlarƒ± Kaydet</button>
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- LEFT PANEL: Forms -->
        <div class="w-5/12 bg-sidebar flex flex-col border-r border-gray-700 shadow-xl z-10 relative">
            <div class="p-6 flex-1 overflow-y-auto">
                
                <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">ƒ∞≈ülem Se√ßimi</h2>
                
                <!-- Scenario Selector -->
                <div class="mb-6">
                    <select id="scenarioSelector" onchange="loadScenario()" class="w-full bg-dark border border-gray-600 rounded-lg px-4 py-3 text-sm text-white focus:outline-none focus:border-accent shadow-sm">
                        <option value="test_connection">üîç Baƒülantƒ± Testi</option>
                        <option value="get_account" selected>1. Yatƒ±rƒ±m - Hesap ƒ∞ste (get-eligible-account)</option>
                        <option value="create_transaction">2. Yatƒ±rƒ±m - ƒ∞ptal/Onay (create-transaction)</option>
                        <option value="withdraw_request">3. √áekim Olu≈ütur (withdraw-request)</option>
                    </select>
                </div>

                <!-- Info Box (Token) -->
                <div id="tokenBox" class="hidden mb-6 bg-indigo-900/30 border border-indigo-500/30 rounded-lg p-3">
                    <div class="text-[10px] text-indigo-300 uppercase font-bold mb-1">Mevcut Process Token</div>
                    <div class="flex gap-2">
                        <input type="text" id="cachedToken" readonly class="flex-1 bg-transparent text-xs font-mono text-white outline-none" value="-">
                        <button onclick="copyToken()" class="text-xs text-indigo-400 hover:text-white">Kopyala</button>
                    </div>
                </div>

                <!-- Dynamic Form Container -->
                <div id="formContainer" class="space-y-4 animate-fadeIn">
                    <!-- Forms injected by JS -->
                </div>

            </div>

            <!-- Action Bar -->
            <div class="p-6 border-t border-gray-700 bg-sidebar/50 backdrop-blur-sm">
                <button onclick="executeScenario()" id="executeBtn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold py-4 px-6 rounded-lg shadow-lg transform transition-all hover:scale-[1.02] flex items-center justify-center gap-2">
                    <span>ƒ∞steƒüi G√∂nder</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                </button>
            </div>
        </div>

        <!-- RIGHT PANEL: Terminal / Results -->
        <div class="w-7/12 bg-dark flex flex-col relative">
            
            <!-- Tabs -->
            <div class="h-12 border-b border-gray-700 flex text-sm">
                <button onclick="switchTab('response')" id="tab-response" class="px-6 border-b-2 border-green-500 text-green-400 font-medium bg-gray-800/30 transition-colors">Gelen Cevap</button>
                <button onclick="switchTab('request')" id="tab-request" class="px-6 border-b-2 border-transparent text-gray-500 hover:text-gray-300 font-medium transition-colors">G√∂nderilen JSON</button>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-gray-600 mt-12">
                <svg class="w-16 h-16 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                <p class="text-sm">ƒ∞≈ülem se√ßip teste ba≈ülayƒ±n.</p>
            </div>

            <!-- Content Area -->
            <div id="resultContent" class="flex-1 overflow-hidden hidden flex flex-col">
                
                <!-- Status Bar -->
                <div class="p-4 flex items-center justify-between border-b border-gray-800">
                    <div id="statusBadge" class="px-3 py-1 rounded text-[10px] font-bold bg-gray-700 text-gray-300 flex items-center gap-2 uppercase tracking-wide">
                        <span class="w-1.5 h-1.5 rounded-full bg-gray-400"></span>
                        BEKLƒ∞YOR
                    </div>
                    <div class="text-[10px] text-gray-500 font-mono flex gap-4">
                        <span id="metaTime">0 ms</span>
                        <span id="metaSize">0 KB</span>
                    </div>
                </div>

                <!-- Response/Request View -->
                <div class="flex-1 overflow-auto bg-[#0b1121] relative group">
                    <button onclick="copyContent()" class="absolute top-2 right-2 text-[10px] bg-gray-800 text-gray-400 px-2 py-1 rounded opacity-0 group-hover:opacity-100 hover:bg-gray-700 transition-all">Kopyala</button>
                    <pre id="view-response" class="code-block text-gray-300 p-4 min-h-full"></pre>
                    <pre id="view-request" class="code-block text-indigo-300 hidden p-4 min-h-full"></pre>
                </div>
            </div>

        </div>
    </div>

    <!-- Logic -->
    <script>
        // --- State ---
        const CSRF_TOKEN = getCookie('csrftoken');
        let currentProcessToken = localStorage.getItem('nx_process_token') || '';

        // --- Config ---
        const SCENARIOS = {
            'test_connection': {
                path: '/test-connection/',
                method: 'GET',
                fields: []
            },
            'get_account': {
                path: '/get-eligible-account/', // Added trailing slash to match typical django/rest patterns, update if strictly no-slash
                method: 'POST',
                fields: [
                    { id: 'amount', label: 'Tutar (Miktar)', type: 'text', value: '15000', placeholder: '15000' }
                ]
            },
            'create_transaction': {
                path: '/create-transaction/',
                method: 'POST',
                fields: [
                    { id: 'process_token', label: 'Process Token (Otomatik)', type: 'text', value: '', placeholder: 'get-account ile alƒ±nƒ±r' },
                    { id: 'user_id', label: 'User ID', type: 'text', value: 'Testuser123', placeholder: 'Kullanƒ±cƒ± ID' },
                    { id: 'full_name', label: 'Ad Soyad', type: 'text', value: 'Test Kullanƒ±cƒ±sƒ±', placeholder: 'Ad Soyad' },
                    { id: 'external_id', label: 'External ID (Order ID)', type: 'text', value: 'order_' + Math.floor(Math.random()*10000), placeholder: 'Sipari≈ü No' },
                    { id: 'callback_url', label: 'Callback URL', type: 'text', value: 'https://webhook.site/test', placeholder: 'Webhook' }
                ]
            },
            'withdraw_request': {
                path: '/public/withdraw-request/',
                method: 'POST',
                fields: [
                    { id: 'customer_name', label: 'Alƒ±cƒ± Adƒ± Soyadƒ±', type: 'text', value: 'AHMET OOOOOO', placeholder: 'Kime' },
                    { id: 'customer_iban', label: 'IBAN', type: 'text', value: 'TR18231289327218937913', placeholder: 'TR...' },
                    { id: 'amount', label: '√áekim Tutarƒ±', type: 'number', value: 15000.00, placeholder: '15000.00' },
                    { id: 'external_id', label: 'External ID', type: 'text', value: 'withdraw_' + Math.floor(Math.random()*10000), placeholder: 'ƒ∞≈ülem No' }
                ]
            }
        };

        // --- Init ---
        window.onload = () => {
            const savedUrl = localStorage.getItem('nx_base_url');
            if (savedUrl) document.getElementById('baseUrl').value = savedUrl;
            
            const savedKey = localStorage.getItem('nx_api_key');
            if (savedKey) document.getElementById('apiKey').value = savedKey;

            if (currentProcessToken) {
                document.getElementById('cachedToken').value = currentProcessToken;
                document.getElementById('tokenBox').classList.remove('hidden');
            }

            loadScenario();
        };

        // --- Actions ---
        function loadScenario() {
            const key = document.getElementById('scenarioSelector').value;
            const config = SCENARIOS[key];
            const container = document.getElementById('formContainer');
            
            container.innerHTML = ''; 

            config.fields.forEach(f => {
                // Auto-fill process token if available
                let val = f.value;
                if (f.id === 'process_token' && currentProcessToken) val = currentProcessToken;
                if (f.id === 'external_id' && (key === 'create_transaction' || key === 'withdraw_request')) val = key.substring(0,4) + '_' + Math.floor(Math.random()*100000);

                container.innerHTML += `
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">${f.label}</label>
                        <input type="${f.type}" id="field_${f.id}" value="${val}" placeholder="${f.placeholder}" 
                            class="w-full bg-card border border-gray-600 rounded p-2.5 text-xs text-white focus:border-accent outline-none font-mono">
                    </div>
                `;
            });
        }

        async function executeScenario() {
            const btn = document.getElementById('executeBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="animate-pulse">ƒ∞≈üleniyor...</span>';
            
            try {
                // Prep
                const key = document.getElementById('scenarioSelector').value;
                const config = SCENARIOS[key];
                const baseUrl = document.getElementById('baseUrl').value.replace(/\/$/, '');
                const targetUrl = baseUrl + config.path;
                const apiKey = document.getElementById('apiKey').value;

                // Payload
                let payload = {};
                config.fields.forEach(f => {
                    const el = document.getElementById('field_' + f.id);
                    // Special logic for amount string/number
                    if (f.id === 'amount' && key === 'get_account') {
                        payload[f.id] = String(el.value); // Ensure string for get-account
                    } else if (f.type === 'number') {
                         payload[f.id] = parseFloat(el.value);
                    } else {
                        payload[f.id] = el.value;
                    }
                });

                // Headers
                let headers = { 'Content-Type': 'application/json' };
                if (apiKey) {
                    // Using X-API-KEY as per standard requirement
                    headers['X-API-KEY'] = apiKey; 
                }

                // UI Updates
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('resultContent').classList.remove('hidden');
                document.getElementById('view-request').innerText = JSON.stringify(payload, null, 4);

                // Call Backend Proxy
                const startTime = performance.now();
                const res = await fetch('/api/run-diagnostic/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
                    body: JSON.stringify({
                        test_type: 'custom',
                        target_url: targetUrl,
                        http_method: config.method,
                        payload: payload,
                        custom_headers: headers
                    })
                });
                
                const data = await res.json();
                const duration = Math.round(performance.now() - startTime);

                // Analyze & Render
                renderResult(data, duration);

                // Logic: Capture Process Token
                if (key === 'get_account' && data.json && data.json.process_token) {
                    currentProcessToken = data.json.process_token;
                    localStorage.setItem('nx_process_token', currentProcessToken);
                    document.getElementById('cachedToken').value = currentProcessToken;
                    document.getElementById('tokenBox').classList.remove('hidden');
                    // Auto switch scenario? Maybe not, allow user to review.
                }

            } catch (err) {
                document.getElementById('view-response').innerText = err.message;
            } finally {
                btn.innerHTML = originalText;
                switchTab('response');
            }
        }

        function renderResult(data, ms) {
             const statusBadge = document.getElementById('statusBadge');
             const view = document.getElementById('view-response');
             
             let code = data.status_code || 0;
             let color = code >= 200 && code < 300 ? 'bg-green-600' : 'bg-red-600';
             let text = code >= 200 && code < 300 ? 'BA≈ûARILI' : 'HATA';
             
             statusBadge.className = `px-3 py-1 rounded text-[10px] font-bold text-white flex items-center gap-2 uppercase tracking-wide ${color}`;
             statusBadge.innerHTML = `<span class="opacity-75">${code}</span> ${text}`;
             
             document.getElementById('metaTime').innerText = ms + ' ms';
             
             const jsonStr = JSON.stringify(data.json || data, null, 4);
             view.innerHTML = syntaxHighlight(jsonStr);
             document.getElementById('metaSize').innerText = (jsonStr.length / 1024).toFixed(2) + ' KB';
        }
        
        // --- Utils ---
        function saveSettings() {
            localStorage.setItem('nx_base_url', document.getElementById('baseUrl').value);
            localStorage.setItem('nx_api_key', document.getElementById('apiKey').value);
            alert('Ayarlar Kaydedildi');
        }
        
        function switchTab(t) {
            document.getElementById('view-response').classList.add('hidden');
            document.getElementById('view-request').classList.add('hidden');
            document.getElementById('view-'+t).classList.remove('hidden');
            
            document.getElementById('tab-response').className = "px-6 border-b-2 border-transparent text-gray-500 hover:text-gray-300 font-medium transition-colors";
            document.getElementById('tab-request').className = "px-6 border-b-2 border-transparent text-gray-500 hover:text-gray-300 font-medium transition-colors";
            
            if(t==='response') {
                document.getElementById('tab-response').className = "px-6 border-b-2 border-green-500 text-green-400 font-medium bg-gray-800/30 transition-colors";
            } else {
                 document.getElementById('tab-request').className = "px-6 border-b-2 border-indigo-500 text-indigo-400 font-medium bg-gray-800/30 transition-colors";
            }
        }

        function getCookie(name) {
            if (!document.cookie) return null;
            const cookies = document.cookie.split(';');
            for (let c of cookies) {
                if (c.trim().startsWith(name + '=')) return decodeURIComponent(c.trim().substring(name.length + 1));
            }
            return null;
        }

        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                var cls = 'text-green-300';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) cls = 'text-indigo-300 font-bold';
                    else cls = 'text-green-300';
                } else if (/true|false/.test(match)) cls = 'text-purple-300';
                else if (/null/.test(match)) cls = 'text-gray-500';
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }
    </script>
</body>
</html>
